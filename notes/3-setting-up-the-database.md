# Setting Up the Database

## Install VSCode extension
1. Install SQLite by alexcvzz
1. Open the Command Palette (Shift+Command+P)
1. Search for `SQLite: Open Database`
1. Select `db.sqlite3`
1. In the explorer panel and expand `SQLITE EXPLORER`

## Migrations
Let Django create and modify our database tables.

Run `makemigrations` each time our models are changed.
```
python manage.py makemigrations
```

Run the migrations to create our database schema.
```
python manage.py migrate
```

To view the SQL code of a given migration use the command `python manage.py` followed by the name of the app and the sequence number of its migration. Example:
```
python manage.py sqlmigrate store 0002
```

## Example
Add zip to Address model, create a migration and inspect the migrations table.

Edit `store/models.py`
```python
class Address(models.Model):
    street = models.CharField(max_length=255)
    city = models.CharField(max_length=255)
    zip = models.CharField(max_length=255, null=True)
    customer = models.ForeignKey(Customer, on_delete=models.CASCADE)
```

Run `makemigrations`
```
python manage.py makemigrations
```

```
python manage.py migrate
```

Hit refresh in `SQLITE EXPLORER` and inspect the migrations table.

## Customizing Database Schema
Some times you need more control of a database schema like overwriting the name of a table or add an index to a couple of columns.

Let's set some metadata to the `Customer` class. (Use `command+t` then type `Customer` to quickly find its declaration).
```python
class Customer(models.Model):
    MEMBERSHIP_BRONZE = 'B'
    MEMBERSHIP_SILVER = 'S'
    MEMBERSHIP_GOLD = 'G'
    
    MEMBERSHIP_CHOICES = [
        (MEMBERSHIP_BRONZE, 'Bronze'),
        (MEMBERSHIP_SILVER, 'Silver'),
        (MEMBERSHIP_GOLD, 'Gold'),
    ]

    first_name = models.CharField(max_length=255)
    last_name = models.CharField(max_length=255)
    email = models.EmailField(unique=True)
    phone = models.CharField(max_length=255)
    birth_date = models.DateField(null=True)
    membership = models.CharField(
        max_length=1,
        choices=MEMBERSHIP_CHOICES,
        default=MEMBERSHIP_BRONZE
    )

    class Meta:
        # It's not recommend to change table names, but this is how its done.
        db_table = 'store_customers'

        # Create indexes
        indexes = [
            models.Index(fields=['last_name', 'first_name'])
        ]
```

Create a migration, then migrate.
```
python manage.py makemigrations
python manage.py migrate
```

## Reverting Migrations
You can undo a migration by migrating to the desired migration sequence.
```
python manage.py migrate store 0003
```
The next sequence(s) still exist, and must be deleted along with the written code. Or if using version control, reset to the prevous commit.
```
git reset --hard HEAD~1
```

## Connecting to Database
1. Verify database named `storefront` exists.
    ```sql
    CREATE DATABASE storefront
    ```
1. Install django package database client
    ```bash
    # mysql
    pipenv install mysqlclient
    ```
    ```bash
    # postgres
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    brew services start postgresql
    pipenv install psycopg2
    ```
1. Update `DATABASES` in `settings.py` (shift+command+o, then type databases).
    ```python
    DATABASES = {
        'default': {
            'ENGINE': 'django.db.backends.postgresql_psycopg2',
            'HOST': 'localhost',
            'PORT': '5432',
            'NAME': 'storefront',
            'USER': 'admin_sa',
            'PASSWORD': 'admin8520',
        }
    }
    ```
1. Migrate models into the new database
    ```bash
    python manage.py migrate
    ```

1. Use vscode extension SQLTools and install the PostgreSQL driver to view the table in the editor.

## Running Custom SQL
For full control over generating or updating our database schema create an empty migration, then write any SQL code.

```bash
python manage.py makemigrations store --empty
# Result: store/migrations/0004_auto_20220501_1651.py
```
In `store/migrations/0004_auto_20220501_1651.py` lets insert a record when this migration is run, and delete the inserted record when the migration is reverted.
```python
# Generated by Django 4.0.4 on 2022-05-01 16:51

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('store', '0003_address_zip'),
    ]

    operations = [
        migrations.RunSQL("""
            INSERT INTO store_collection (title)
            VALUES ('collection1')
        """, """
            DELETE FROM store_collection
            WHERE title='collection1'
        """)
    ]

```
Run the migration to update the database with the new record.
```bash
python manage.py migrate
```
Finally test reverting the migration.
```bash
python manage.py migrate store 0003
```

## Generating Dummy Data
Visit mockaroo.com to quicly generate dummy data. Everything is pretty self explanatory. For choice options use a regex like `(B|S|G)`.